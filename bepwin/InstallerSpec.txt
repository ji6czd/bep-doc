BEPインストーラの仕様(案)

2002年1月7日
渡辺隆行 <takayuki@la.shonan-it.ac.jp>
$Id: InstallerSpec.txt,v 1.1 2002/01/07 15:49:38 watanabe Exp $

BEP (Bilingual Emacspeak Platform)は、視覚障害者用の日英2ヶ国語Emacs音声化
システムです。BEPのインストーラに必要な機能を以下に述べます。
なお、我々が作った低機能な簡単インストーラを以下のftpサイトで公開しています。
ftp://ftp.m17n.org/pub/bep/win32/beta/bepw01-pre7.exe
一度これをインストールしていただくと、どういうものを作るべきかの理解の助けに
なると思います。
また、この文書の後半にEmacsやBEPの簡単な説明をつけましたのでそれもあわせて
読んでください。

----------------------------------------------------------------------------
インストーラには以下の機能が必要です。

0) インストーラ作成にはInstallStudioを使う。このソフトは視覚障害者が使った
   実績があります。

1) 全盲の視覚障害者が一人でインストール、アップグレード、アンイストールできる。
   ユーザは95ReaderなどやPC-Talkerのスクリーンリーダを使っていると仮定する。
   つまり、スクリーンリーダが対応しているダイアログボックスなどを使う。
   短いwaveファイルで案内することも可能。
   スクリーンリーダが読み上げることができない機能は使わない。
   DOSプロンプトでの作業も行わせない。
   スクリーンリーダに対応出来ているかどうかのチェックはこちらでやることも可能。
   
2) OSはWindows 98、98SE、Me、2000、XPに対応する。(Win95とNTを除外しました。)

3) ネットワーク越しにダウンロードすることを仮定する。
  全部で20MB近くになるので、アナログ電話でのダウンロードはかなりきつい作業に
  なる。分割インストールも出来ることが望ましい。
  
4) EmacsやBEPやUnixの基礎知識がないユーザでもインストールできる。
  つまりユーザには簡単な質問しかしないし、その場合もデフォルトの設定を用意
  しておく。

5) 既存のスクリーンリーダ環境に悪影響を与えない。
 これが問題になるのはSAPIのインストールと音声合成ライブラリのインストール：
問題点：SAPIのインストールにも責任を持つか。それともユーザに別個にさせるか。
問題点：ProTalkerに関してはreadmeに注意を書くだけでよいか?
 
6) 納品されたインストーラを後で我々が変更して、細部を修正した新バージョンの
  インストーラを簡単に作れるようになっていること。
  
7) インストーラは以下のモジュールを管理する。
  ・Meadow本体のファイル群
  ・BEPのEmacs Lispパッケージ
  ・Windows SS (Speak.exe)
  ・ドキュメントや初期化ファイル
  （Mewなどのパッケージは入れない。）
問題点：将来はMewなどのパッケージも管理できるようにしたい。(予定)

8) インストールの手順：
 (1) readme.txtを表示する。このファイルはこちらで用意する。
 (2) インストールかアンインストールかを選択させる。また各手順で元に戻ることも
    出来るようにする。
 (3) SAPI 4が入っているかどうか確認する。入っていない場合はメッセージを出す。
    また、SAPI 4をインストールしてよいかどうか問い合わせて、OKならばネット
    ワーク越しにダウンロードしてインストールする。
    注意：SAPI 3を使っているユーザがいるが、BEPはSAPI 4でしか動かない。
問題点： SAPI 3を使っている場合の対処はどうすべきか?
 (4) 音声合成エンジンの種類を確認する。正しいものが入っていない場合はメッセージ
    を出す。
    また、英語エンジンに関してはMSのエンジンをインストールしてよいかどうか
    問い合わせて、OKならばネットワーク越しにダウンロードしてインストールする。
 (5) デフォルトインストールかカスタムインストールかを選ぶ。

デフォルトインストールの場合：
 (6) Meadowの初期設定ファイルなどを置くhomeディレクトリをどこにするかを
   ユーザに問い合わせる。defaultはMeadowディレクトリの下のhomeディレクトリ。
   もしユーザが半角英数字といくつかの記号以外の文字でディレクトリを指定したら、
   BEPが正常に動作しない可能性があると言うメッセージを表示。
 (7) BEPをインストールする場所(これをMeadowディレクトリと呼び、この下にすべての
    モジュールがインストールされる)を問い合わせる。defaultは C:\Meadow。
   もしユーザがルートディレクトリを指定したら、ルートの下にMeadowという名の
   ディレクトリを作ってその下にインストールした方がよいと表示。
   もしユーザが半角英数字といくつかの記号以外の文字でディレクトリを指定したら、
   BEPが正常に動作しない可能性があると言うメッセージを表示。
 (8) HDの空き容量不足の場合は不足容量を示すメッセージを出して停止。
 (9) このディレクトリを作る。homeがdafaultの場合はそれも作る。
 (10) Meadowを展開。BEPも展開。展開すべきファイルはこちらで用意する。
 (11) Meadowのインストーラの引数にhomeディレクトリの場所を渡して、
     Meadowのインストーラを実行。
 (12) 終了メッセージを表示。このファイルもこちらで用意する。
問題点：ELispをMeadowディレクトリの下に作らないオプションが必要か?

カスタムインストールの場合：
 (6) インストールするモジュールを選択させる。
  ・Meadowの場合は新しいMeadowを展開してからMeadowのインストーラを再実行する。
    バージョンが違うMeadowはインストールする場所も違うから競合する心配はない。
問題点：elispのbyte-compileをどうするか。
  ・WindowsSSの場合は、古いSSをバックアップしてから新しいSSをコピーする。
  ・BEP Lispの場合は、古いバージョンをバックアップ(rename)してから新しいバージョンを展開する。
  ・homeディレクトリの下のファイルには手を触れない。変更もしない。
 (7) あとは上記デフォルトインストールに準じた処理をする。

9) アンインストール：
 (1) 全部消すのか個別に消すのか尋ねる。
全部消す場合：
  ・インストール時に指定したディレクトリ以下のファイルを消す。
    ただし home の下は残す。またその旨を表示する。
  ・レジストリもチェックしてMeadowのレジストリが残っていたら消す。
個別に消す場合：
   上記処理に準ずる。

-------------------------------------------------------------------------
参考までにBEPの動作原理やEmacsの基礎知識を書いておきます。
ご存知のことも多いと思いますが念のため。

1. BEPの動作原理

1.1 Emacs

BEPはEmacsを音声化するシステムです。EmacsはUnixで標準的な高機能エディタですが、Emacs Lisp (ELisp)プログラミング言語のプラットホームでもあり、Emacs自身もprimitiveな機能はCで書かれていますが、それ以外はELispで実装されています。
またEmacsにはいろいろな亜種があり、Unix以外のOSでもかなりコンパイルできるようになっています。我々がWindowsで使っているのはMeadowという名のEmacsで、MS IMEやホイールマウスなどに対応しています。

現在のMeadowのバージョンは1.15で、Emacs 20.7に対応します。
Emacs自身は最近Emacs 21がリリースされ、かなりGUI化されました。

またEmacsは GNU GPLというライセンスで公開されており、ソースの再配布や改変の自由が保障されています。我々のBEPも同じライセンスで公開しています。

1.2 ELispとバイトコンパイル

ELispコードのファイルはel (Emacs Lispの略)という拡張子を持ちます。Lispはインタープリタ型の言語でありこのままでは実行速度が遅くなるので、あらかじめelファイルをバイトコンパイルしておきます。バイトコンパイルしたファイルの拡張子は elc です。el ファイルと elc ファイルの両方がある場合は elc を読み込みますが、 el しかない場合は el を読み込みます。注意しなければいけないのは、バイトコンパイルされたELispコードはEmacsのバイジョンが違うと互換性がない場合があるということです。したがって、Emacsを変えた場合は、バイトコンパイルしなおした方が安全です。これは普通Makefileなどを使って、素のEmacs、つまり余分なコードをロードしていないEmacs、を使ってコンパイルしなおします。

1.3 BEPの原理と構成要素

BEPはELisp部分と、スピーチサーバの2つのソフトウェアで構成されます。Elisp部分(BEP部と呼ぶことが多い)はEmacsの関数にhookして、Emacsの情報を取り出します。
このELispファイルだけでもかなりの数のファイルで構成されます。これはもともとRaman博士が書いたEmacspeakを2ヶ国語に拡張して日本語特有の機能を追加したものです。まだまだ未完成ですが、使えるようになってきています。
このElisp部は大きく分けて2つのバージョンがありますが、今回使うのは最初のバージョンです(BEP1と呼びましょう。)。しかし2月ごろには新しいバージョン(BEP2)に置き換えたいと思っています。
新しいバージョンは、Elisp部で言語を判断し、音声化に使うエンジンの言語を指定できます。

スピーチサーバは独立したアプリケーションです。BEPにはWindows用とLinux用の2つのスピーチサーバを開発しています。スピーチサーバは、標準入力に送り込まれた文字列を解析して、インテキストコマンドを解釈し、文字列を読み上げます。Windows版はSAPI 4に対応した音声合成ライブラリを使っており Speak.exe という名前です。これにもいくつかバージョンがあり、

SS1：英語はMSの英語のエンジン、日本語はProTalkerがしゃべり、日米両言語を自動切換えしてしゃべる。BEP1に対応。今回の簡単インストーラに同梱されている。

SS2：英語も日本語も東芝がしゃべる。英語はカタカナ英語でしゃべる。1月中にこのSSを用いた簡単インストーラを出す予定。

SS3：BEP2に対応したスピーチサーバで、英語はMSの英語のエンジン、日本語は東芝がしゃべる。また英語をカタカナ英語でしゃべらすことも出来る。2月までに完成させます。

SS4: 日本語のエンジンを、東芝とドキュメントトーカから選べるようにする。
日本語は全部ドキュメントトーカにしたり、日本語は東芝、カタカナ英語はドキュメントトーカとか使い分けることが出来るようにしたい。これも2月中に作りたいのですが、私の力量では苦しいので小出さんのところで外注しようと思ったわけです。

1.4 EmacsのLispライブラリ (Lispパッケージとかモジュールとかいうこともあります)

Emacsが面白いというか、高機能なのはELispで書かれたパッケージを用いて機能を拡張できることです。BEP自身もそういう機能拡張の一種ですが、電子メール Mew、Webブラウザ W3やw3m、ファイラー dired、shell、などの各種パッケージがあります。このようなELispパッケージは site-lisp という名前のディレクトリの下に入れられます。

1.5 ディレクトリ構成

今のEmacsのディレクトリ構成を書くと

Meadow\1.15\            1.15はバージョン名です。
            bin\        Speak.exeなどの実行形式を置く場所
            etc\        その他のファイル
            lisp\       Emacs本体のELispファイル
            site-lisp\  Emacsのバージョンに依存するパッケージを置く場所
            info\       info というUnix形式のマニュアルの置き場所
            
       site-lisp\       Emacsのバージョンに依存しないパッケージを置く場所
                 emacspeak\
                 mew\
                 w3m\

という風になっています。
今回のdefaultは C:\Meadow 以下にファイルを置くつもりです。

これ以外に大事なディレクトリが ホームディレクトリです。
Unixの場合はログインディレクトリがホームディレクトリですがWindowsにはそういう概念がないので、どこをホームディレクトリにするか設定してあげなければいけません。
(MeadowやMewなどいくつかのプログラムがこのディレクトリに設定ファイルを置きます。)
今回の簡易インストーラでは簡便のために、defaultでは Meadow\home\ というディレクトリを作ります。

注意すべきことは、Emacs関連のアプリケーションは日本語や空白が含まれるディレクトリ名を扱えない可能性があるということです。ですからユーザが、"Program Files"とか"Documents and Settings"とか"渡辺"とかいう名前のディレクトリを使おうとした場合は警告してはねる必要があります。

1.6 Meadowのインストール

Meadowのインストールはとっても簡単で、Meadowの配布ファイルを展開した後、
Meadow\1.15\install.exe を実行するだけです。このインストーラはhomeディレクトリの設定とdumpという作業を行います。install.exeのコマンド引数でホームディレクトリの場所を指定できます。ちなみに環境変数homeが設定されていれば、Meadowはそれを検出してその場所をMeadowのホームディレクトリにします。そしてその値をレジストリに書き込みます。

Meadowは特別なDLLを別に必要としないはずです。

1.7 BEPのインストール

我々が作った簡単インストールでは、BEPのELispはバイトコンパイルした状態で配布しています。EmacsとバイトコンパイルされたBEPの相性の問題を考えなくてよいならばこの状態で配布して、site-lispの下に展開して、初期設定ファイル Meadow\site-lisp\site-start.el を設定してやればそれで終わりです。そうでない場合をどうするかはまだ考慮中です。
BEPも特別なDLLなどを必要としません。

1.8 スピーチサーバのインストール

これは簡単です。Meadow\1.15\bin\Speak.exe におけば終わり。
スピーチサーバは以下のMFCのDLLを必要とします。
MFC42D.DLL  MFCO42D.DLL  MSVCRTD.DLL

以上。