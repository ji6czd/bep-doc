BEPインストーラの仕様(案)

2002年1月8日
渡辺隆行 <takayuki@la.shonan-it.ac.jp>
$Id: InstallerSpec.txt,v 1.3 2002/01/08 16:46:55 watanabe Exp $

BEP (Bilingual Emacspeak Platform)は、視覚障害者用の日英2ヶ国語Emacs音声化
システムです。Emacsのことをよく知らない初心者にBEPを使ってもらうための
インストーラを作ってください。インストーラに必要な機能を以下に述べます。
なお、我々が作った低機能な簡単インストーラを以下のftpサイトで公開しています。
ftp://ftp.m17n.org/pub/bep/win32/beta/bepw01-pre7.exe
一度これをインストールしていただくと、どういうものを作るべきかの理解の助けに
なると思います。
また、この文書の後半にEmacsやBEPの簡単な説明をつけましたのでそれもあわせて
読んでください。

----------------------------------------------------------------------------
インストーラには以下の機能が必要です。

0) インストーラ作成にはInstallStudioを使う。このソフトは視覚障害者が使った
   実績があります。

1) 全盲の視覚障害者が一人でインストール、アップグレード、アンイストールできる。
   ユーザは95ReaderなどやPC-Talkerのスクリーンリーダを使っていると仮定する。
   つまり、スクリーンリーダが対応しているダイアログボックスなどを使う。
   短いwaveファイルで案内することも可能。
   スクリーンリーダが読み上げることができない機能は使わない。
   DOSプロンプトでの作業も行わせない。
   スクリーンリーダに対応出来ているかどうかのチェックはこちらでやることも可能。
   
2) OSはWindows 98、98SE、Me、2000、XPに対応する。(Win95とNTを除外しました。)

3) ネットワーク越しにダウンロードすることを仮定する。
  全部で20MB近くになるので、アナログ電話でのダウンロードはかなりきつい作業に
  なる。分割インストールも出来ることが望ましい。つまり最初の小さなインストーラ
  が、分割された残りをダウンロードして合体する。
  
問題点:
  setup.exeだけをローカルに置いて、必要なモジュールはインストーラがネットワーク
  越しに取ってきてローカルに保存した後でインストールする、或いはローカルに既に
  あればそれを使うというやり方も考えられるが、今回はすべて込みのインストーラに
  することでよいか？ MeadowとBEPを別にインストールする場合は分かれていたほうが
  都合よいけど。
  
4) このインストーラは初心者、つまりEmacsやBEPやUnixの基礎知識がないユーザを
  対象にする。
  ユーザには簡単な質問しかしないし、その場合もデフォルトの設定を用意しておく。

5) 既存のスクリーンリーダ環境に悪影響を与えない。
 これが問題になるのはSAPIのインストールと音声合成ライブラリのインストール。
 ユーザに注意を喚起するメッセージを出す。
 
6) 納品されたインストーラを後で我々が変更して、細部を修正したり機能を拡張したり
  した新バージョンのインストーラを簡単に作れるようになっていること。
  つまり、今回のインストーラ作成スクリプトもこちらに無償で提供すること。
  またそのスクリプトを我々が自由に改変できること。読みやすく改変しやすいように
  作ってあること。
  
7) インストーラは以下のモジュールを管理する。
  ・Meadow本体のファイル群 (Meadow-1.15-i386-els.tar.gz)
問題点：名前が8文字を超えているけど、これでよいか？
  ・BEPのEmacs Lispパッケージ (beplsp01.exe)
  ・Windows SS：Speak.exeのこと。(winss01.exe)
  ・ドキュメントや初期化ファイルなど上記に入らないもの (bepetc01.exe)
  ・その他
   # 今回はMewなどのLispパッケージは管理しない。将来の宿題にする。

8) ユーザがhome環境変数を設定していたらそれを使う。このインストーラで前にBEPを
 インストールしていたらそのときの場所を使う。そうでなかったら default値として
 C:\meadow\home を使う。いずれの場合もユーザにこれでよいか確認を求める。
 このhomeディレクトリの場所は、Meadowのインストール時などに使われる。
 
 またhomeディレクトリが既に存在していた場合、そこにあるファイルを勝手に上書き
 したり消したりしてはいけない。
 
9) インストールの手順：
 (1) インストーラのアーカイブ (bepwin01.exe)を解凍すると
     setup.exe、readme.txt、modulesディレクトリの下のモジュール群(すなわち
     Meadow-1.15...、beplsp01.exe、winss01.exe、bepetc01.exe)に展開される。
問題点：このsetup.exeだけをローカルにおいて、あとはsetup.exeがネットワーク越し
     にとってくることができるようにもするか?
 (2) readme.txtを表示する。このファイルはこちらで用意する。
    このファイルの中でBEPやEmacsを終了して作業するように知らせる。
 (3) ユーザがsetup.exe を実行する。
 (4) インストールかアンインストールかを選択させる。
    注意; インストーラは各手順で元に戻ることも出来るようにする。

8A)インストール作業の場合
 (1) SAPI 4が入っているかどうか自動的に確認する。入っていない場合はメッセージ
    を出す。また、SAPI 4をインストールしてよいかどうか問い合わせて、OKならば
    ネットワーク越しにダウンロードしてインストールする。
    spchapi.exe (825KB)の場所：
      http://activex.microsoft.com/activex/controls/sapi/spchapi.exe
    SAPI 3を使っているユーザがいるが、BEPはSAPI 4でしか動かない。
    SAPI 3を使っている場合は「BEPを使うにはSAPI4が必要だがSAPI 4を入れる
    と既存の音声合成環境に不具合が出る可能性がある」というメッセージを
    出してインストールを中止する。
 (2) 音声合成エンジンの種類を確認する。必要なものが入っていない場合はメッセージ
    を出す。
    ・英語エンジンに関してはMSのエンジンをインストールしてよいかどうか
     問い合わせて、OKならばネットワーク越しにダウンロードしてインストールする。
     msttsL.exe (7.3MB)の場所：
     http://download.microsoft.com/msdownload/sapi/4.0/rtw/4.0a/en/msttsL.EXE
    ・日本語エンジン：今回はProTalker。以下のメッセージを出す。
 
          日本語音声合成ライブラリの IBM ProTalker 97 は、IBM の商品 
       (9800円) です。Protalker 97 は、音声合成だけの単体の商品として
       パソコンショップで購入できます。
          IBM のホームページリーダーや、PC-Talker/VDM100W あるいは JAWS 
       などは内部的に IBM ProTalker 97 を使用しています。したがって、
       これらのソフトウェアが既にインストールされている場合は、特に何
       もしなくても BEP は動作します。ただし、ライセンスの関係上 BEP 
       用には別途単体版の ProTalker を購入する必要があります。

       [注意] すでに ProTalker が動作している環境で更に単体版の 
       ProTalker をインストールすると、既存の環境がおかしくなる可能性
       があります。不明の点は BEP メーリングリスト (下記) までお問い合
       わせください。

     次バージョンでは東芝やドキュメントトーカを使う予定だが、今回は考慮しなく
     てもよい。
     
 (3) おまかせインストールか標準インストールかカスタムインストールかを選ぶ。
   ・おまかせインストール：ユーザは何も指定できない。すべてdefaultの状態で
           インストールされる。
   ・標準インストール：インストール場所やhomeディレクトリの場所を選べる。
   ・カスタムインストール：一部のモジュールだけをインストールできるが、
           Emacsの知識がないとうまく動かないことがあるのでユーザの責任で
           このインストールを行うこと。

8A1) おまかせインストールの場合：
 (1) すでにMeadowやBEPが存在していないか調べる。もしあったらその旨メッセージを
   出し、homeディレクトリ以外を完全に消してよいかどうか確認する。
   OKだったら8B1の完全アンインストールの作業を行う。
   Noだったら作業を中断する。
 (2) HDの空き容量不足の場合は不足容量を示すメッセージを出して停止。
 (3) もしユーザがhome環境変数を設定していたら4でそれを使う。
 (4) インストールされる場所(C:\Meadow)やホームディレクトリの場所
     (C:\Meadow\home)を表示して確認を求める。
 (5) この２つのディレクトリを作る。
 (6) Meadowを展開。BEPも展開。展開すべきファイルはこちらで用意する。
 (7) Meadowのインストーラの引数にhomeディレクトリの場所を渡して、
     Meadowのインストーラを実行。
 (8) .emacs が存在していない場合、後で便利なようにEmacsの初期化ファイルを作る
     かどうか尋ねる。Yesだったら homeディレクトリに ダミーの .emacs を置く。
 (9) 終了メッセージを表示。このファイルもこちらで用意する。

8A2) 標準インストールの場合：
 (1) すでにMeadowやBEPが存在していないか調べる。もしあったらその旨メッセージを
   出し、homeディレクトリ以外を完全に消してよいかどうか確認する。
   OKだったら8B1の完全アンインストールの作業を行う。
   Noだったら作業を中断する。
 (2) もしユーザがhome環境変数を設定していなかったら、Meadowの初期設定ファイル
   などを置くhomeディレクトリをどこにするかをユーザに問い合わせる。
   defaultはMeadowディレクトリの下のhomeディレクトリ。home環境変数が設定されて
   いたらそれを使う。
   もしユーザが半角英数字といくつかの記号以外の文字でディレクトリを指定したら、
   BEPが正常に動作しない可能性があると言うメッセージを表示。
 (3) BEPをインストールする場所(これをMeadowディレクトリと呼び、この下にすべての
    モジュールがインストールされる)を問い合わせる。defaultは C:\Meadow。
   もしユーザがルートディレクトリを指定したら、ルートの下にMeadowという名の
   ディレクトリを作ってその下にインストールした方がよいと表示。
   もしユーザが半角英数字といくつかの記号以外の文字でディレクトリを指定したら、
   BEPが正常に動作しない可能性があると言うメッセージを表示。
 (4) HDの空き容量不足の場合は不足容量を示すメッセージを出して停止。
 (5) このディレクトリを作る。homeがdafaultの場合はそれも作る。
 (6) Meadowを展開。BEPも展開。展開すべきファイルはこちらで用意する。
 (7) Meadowのインストーラの引数にhomeディレクトリの場所を渡して、
     Meadowのインストーラを実行。
 (8) .emacs が存在していない場合、後で便利なようにEmacsの初期化ファイルを作る
     かどうか尋ねる。Yesだったら homeディレクトリに ダミーの .emacs を置く。
 (9) 終了メッセージを表示。このファイルもこちらで用意する。

8A3) カスタムインストールの場合：
 (1) インストールするモジュールを選択させる。
  ・Meadowの場合：
    a) Meadowのバージョンが違うとバイトコンパイルされたLispパッケージが動かなく
     なる可能性があることとユーザの責任で対処することを警告する。
    b) ユーザがhome環境変数を設定していたらそれを使う。そうでない場合、
     homeディレクトリの場所を問い合わせる。defaultの値として、初インストール
     だったら C:\Meadow\home を与え、前にインストールしたことがある場合は
     前回の値を与える。
    c) Meadowをインストールする場所を問い合わせる。defaultの値として、
     初インストールだったら C:\Meadow、再インストールだったら前のディレクトリを
     与える。
    d) HDの空き容量不足の場合は不足容量を示すメッセージを出して停止。
    e) 新しいMeadowを展開する。
     バージョンが違うMeadowはインストールする場所も違うから競合する心配はない。
    f) bのhomeディレクトリの値を引数に与えてMeadowのインストーラを再実行する。
    g) 古いMeadowを消すかどうか問い合わせてそれに応じた処理をする。
    h) .emacs が存在していない場合、後で便利なようにEmacsの初期化ファイルを作る
     かどうか尋ねる。Yesだったら homeディレクトリに ダミーの .emacs を置く。

  ・BEP Lispの場合：
    a) このLispパッケージをバイトコンパイルしたMeadowと、ユーザが使っている
     Meadowのバージョンが違う場合、バイトコンパイルされたBEPパッケージが
     動かなくなる可能性があることとユーザの責任で対処することを警告する。
    b) どこにインストールするか問い合わせる。defaultの値として、
     初インストールだったら C:\Meadow\site-lisp\emacspeak、
     再インストールだったら前のディレクトリを与える。
    c) 古いLispをバックアップする。(デイレクトリの名前を emacspeak-bak1の
     ようなユニークな名前に変える)
    d) HDの空き容量不足の場合は不足容量を示すメッセージを出して停止。
    e) BEP Lispをインストールする。
    f) site-start.el も入れる。
    
  ・WindowsSSの場合：
    a) HDの空き容量不足の場合は不足容量を示すメッセージを出して停止。
    b) 初インストールの場合、Meadowを探してこのMeadowでよいかユーザに問い合わ
      せる。そしてそのMeadowのbinディレクトリの下にインストールする。
      そうでない場合、古いSSをバックアップ(.bak0 というユニークな番号をつける)
      してから新しいSSをコピーする。
      
 (2) 終了メッセージを出す。このメッセージもこちらで用意する。
 
8B) アンインストールの場合：
 (1) 全部消すのか個別に消すのか尋ねる。

8B1) 全部消す場合：
 (1) Meadow、BEP Elispを、インストールしたディレクトリごと消す。
    ただし home の下だけは残して、その旨を表示する。
 (2) レジストリもチェックしてMeadowのレジストリが残っていたら消す。
    とにかくhomeディレクトリ以外は一切の痕跡を残さない。

8B2) 個別に消す場合：
   上記処理に準ずる。

10) インストーラは前回インストールしたモジュールの名前とインストールした場所と
  homeディレクトリの場所をどこかに書き込んでおく。この値をアンインストールや
  カスタムインストール時の上書きの可否に利用する。
  
-------------------------------------------------------------------------
参考までにBEPの動作原理やEmacsの基礎知識を書いておきます。
ご存知のことも多いと思いますが念のため。

1. BEPの動作原理

1.1 Emacs

BEPはEmacsを音声化するシステムです。EmacsはUnixで標準的な高機能エディタですが、Emacs Lisp (ELisp)プログラミング言語のプラットホームでもあり、Emacs自身もprimitiveな機能はCで書かれていますが、それ以外はELispで実装されています。
またEmacsにはいろいろな亜種があり、Unix以外のOSでもかなりコンパイルできるようになっています。我々がWindowsで使っているのはMeadowという名のEmacsで、MS IMEやホイールマウスなどに対応しています。

現在のMeadowのバージョンは1.15で、Emacs 20.7に対応します。
Emacs自身は最近Emacs 21がリリースされ、かなりGUI化されました。

またEmacsは GNU GPLというライセンスで公開されており、ソースの再配布や改変の自由が保障されています。我々のBEPも同じライセンスで公開しています。

1.2 ELispとバイトコンパイル

ELispコードのファイルはel (Emacs Lispの略)という拡張子を持ちます。Lispはインタープリタ型の言語でありこのままでは実行速度が遅くなるので、あらかじめelファイルをバイトコンパイルしておきます。バイトコンパイルしたファイルの拡張子は elc です。el ファイルと elc ファイルの両方がある場合は elc を読み込みますが、 el しかない場合は el を読み込みます。注意しなければいけないのは、バイトコンパイルされたELispコードはEmacsのバイジョンが違うと互換性がない場合があるということです。したがって、Emacsを変えた場合は、バイトコンパイルしなおした方が安全です。これは普通Makefileなどを使って、素のEmacs、つまり余分なコードをロードしていないEmacs、を使ってコンパイルしなおします。

1.3 BEPの原理と構成要素

BEPはELisp部分と、スピーチサーバの2つのソフトウェアで構成されます。Elisp部分(BEP部と呼ぶことが多い)はEmacsの関数にhookして、Emacsの情報を取り出します。
このELispファイルだけでもかなりの数のファイルで構成されます。これはもともとRaman博士が書いたEmacspeakを2ヶ国語に拡張して日本語特有の機能を追加したものです。まだまだ未完成ですが、使えるようになってきています。
このElisp部は大きく分けて2つのバージョンがありますが、今回使うのは最初のバージョンです(BEP1と呼びましょう。)。しかし2月ごろには新しいバージョン(BEP2)に置き換えたいと思っています。
新しいバージョンは、Elisp部で言語を判断し、音声化に使うエンジンの言語を指定できます。

スピーチサーバは独立したアプリケーションです。BEPにはWindows用とLinux用の2つのスピーチサーバを開発しています。スピーチサーバは、標準入力に送り込まれた文字列を解析して、インテキストコマンドを解釈し、文字列を読み上げます。Windows版はSAPI 4に対応した音声合成ライブラリを使っており Speak.exe という名前です。これにもいくつかバージョンがあり、

SS1：英語はMSの英語のエンジン、日本語はProTalkerがしゃべり、日米両言語を自動切換えしてしゃべる。BEP1に対応。今回の簡単インストーラに同梱されている。

SS2：英語も日本語も東芝がしゃべる。英語はカタカナ英語でしゃべる。1月中にこのSSを用いた簡単インストーラを出す予定。

SS3：BEP2に対応したスピーチサーバで、英語はMSの英語のエンジン、日本語は東芝がしゃべる。また英語をカタカナ英語でしゃべらすことも出来る。2月までに完成させます。

SS4: 日本語のエンジンを、東芝とドキュメントトーカから選べるようにする。
日本語は全部ドキュメントトーカにしたり、日本語は東芝、カタカナ英語はドキュメントトーカとか使い分けることが出来るようにしたい。これも2月中に作りたいのですが、私の力量では苦しいので小出さんのところで外注しようと思ったわけです。

1.4 EmacsのLispライブラリ (Lispパッケージとかモジュールとかいうこともあります)

Emacsが面白いというか、高機能なのはELispで書かれたパッケージを用いて機能を拡張できることです。BEP自身もそういう機能拡張の一種ですが、電子メール Mew、Webブラウザ W3やw3m、ファイラー dired、shell、などの各種パッケージがあります。このようなELispパッケージは site-lisp という名前のディレクトリの下に入れられます。

1.5 ディレクトリ構成

今回の標準ディレクトリ構成は、

(C:\ の直下に)
 Meadow\1.15\            1.15はバージョン名です。
             bin\        ＜＝ ここが Speak.exe の置き場所
             etc\        その他のファイル
             lisp\       Emacs本体のELispファイル
             site-lisp\  Emacsのバージョンに依存するパッケージを置く場所
             info\       info というUnix形式のマニュアルの置き場所
            
        site-lisp\       Emacsのバージョンに依存しないパッケージを置く場所
                  emacspeak\ ＜＝ ここが BEP Elispの置き場所
                  mew\ (これは入っていない)
                  w3m\ (これも入っていない)

という風になっています。
今回のdefaultは C:\Meadow 以下にファイルを置くつもりです。

これ以外に大事なディレクトリが ホームディレクトリです。
Unixの場合はログインディレクトリがホームディレクトリですがWindowsにはそういう概念がないので、どこをホームディレクトリにするか設定してあげなければいけません。
(MeadowやMewなどいくつかのプログラムがこのディレクトリに設定ファイルを置きます。)
今回の簡易インストーラでは簡便のために、defaultでは Meadow\home\ というディレクトリを作ります。

注意すべきことは、Emacs関連のアプリケーションは日本語や空白が含まれるディレクトリ名を扱えない可能性があるということです。ですからユーザが、"Program Files"とか"Documents and Settings"とか"渡辺"とかいう名前のディレクトリを使おうとした場合は警告してはねる必要があります。

1.6 Meadowのインストール

Meadowのインストールはとっても簡単で、Meadowの配布ファイルを展開した後、
Meadow\1.15\install.exe を実行するだけです。このインストーラはhomeディレクトリの設定とdumpという作業を行います。install.exeのコマンド引数でホームディレクトリの場所を指定できます。ちなみに環境変数homeが設定されていれば、Meadowはそれを検出してその場所をMeadowのホームディレクトリにします。そしてその値をレジストリに書き込みます。

Meadowは特別なDLLを別に必要としません。

1.7 BEPのインストール

我々が作った簡単インストールでは、BEPのELispはバイトコンパイルした状態で配布しています。EmacsとバイトコンパイルされたBEPの相性の問題を考えなくてよいならばこの状態で配布して、site-lispの下に展開して、初期設定ファイル Meadow\site-lisp\site-start.el を設定してやればそれで終わりです。そうでない場合をどうするかはまだ考慮中です。
BEPも特別なDLLなどを必要としません。

1.8 スピーチサーバのインストール

これは簡単です。Meadow\1.15\bin\Speak.exe におけば終わり。
スピーチサーバは以下のMFCのDLLを必要とします。
MFC42D.DLL  MFCO42D.DLL  MSVCRTD.DLL

以上。