BEPインストーラの仕様原案 (Ver 1.1)

2002年1月12日
渡辺隆行 <takayuki@la.shonan-it.ac.jp>
$Id: InstallerSpec.txt,v 1.8 2002/01/13 13:11:54 mitsugu Exp $

BEP (Bilingual Emacspeak Platform)は、視覚障害者用の日英2ヶ国語Emacs音声化
システムです。Emacsのことをよく知らない初心者にBEPを使ってもらうための
BEPのインストーラを作ってください。インストーラに必要な機能を以下に述べます。

なお、我々が作った低機能な簡単インストーラを以下のftpサイトで公開しています。
ftp://ftp.m17n.org/pub/bep/win32/release/bepw01.exe
一度これをインストールしていただくと、どういうファイルを配布するか、どういう
ものを作るべきか、BEPはどういうものかなど、今回のインストーラを作成する上で
理解の助けになる情報が得られると思います。

また、この文書の後半にEmacsやBEPの簡単な説明をつけましたのでそれもあわせて
読んでください。

----------------------------------------------------------------------------
インストーラには以下の機能が必要です。

1) インストーラ作成にはInstallShield Developerを使う。
   このソフトは視覚障害者でも何とか使えそうですし、このソフトで作成した
   インストーラは95Readerで読み上げ可能なことを確認しました。

2) 全盲の視覚障害者が一人でインストール、アップグレード、アンイストールできる。
   ユーザは95Readerなどのスクリーンリーダを使っていると仮定する。
   つまり、スクリーンリーダが対応しているダイアログボックスなどを使う。
   # InstallShieldが使うダイアログボックスは大丈夫だと思いますが、
   # 確認する必要はあります。
   短いwaveファイルで案内することも可能。
   スクリーンリーダが読み上げることが難しい機能は使わない。
   そういう意味でDOSプロンプトでの作業も行わせない。
   スクリーンリーダに対応出来ているかどうかの最後のチェックはこちらで
   やりますよ。
   
3) OSはWindows 98、98SE、Me、2000、XPに対応する。(Win95とNTを除外しました。)

4) インストーラはftpで配布する。
  将来はCD-Rで配布することも考えている。
  ・まず単体のインストーラを作って欲しい。
  ・全部で20MB近くになるので、それとは別に小さいsetup.exeだけをまず
    ダウンロードして、setupが残りを分割ダウンロードするバージョンも
    作って欲しい。(大きなファイルを一度にダウンロードするのは大変なので
    いくつかに分割したファイルを自動的にダウンロードしてきて欲しい。)
    インストーラ作成ソフトの機能で作れるはず。
  
5) このインストーラは初心者、つまりEmacsやBEPやUnixの基礎知識がないユーザを
  対象にする。
  ユーザには簡単な質問しかしないし、その場合もデフォルトの設定を用意しておく。

6) 既存のスクリーンリーダ環境に悪影響を与えない。
  これが問題になるのはSAPIのインストールと音声合成ライブラリのインストール。
  この場合、作業の前にユーザに注意を喚起するメッセージを出す。
 
7) 納品されたインストーラを後で我々が自由に変更して、細部を修正したり機能を
  拡張したりした新バージョンのインストーラを簡単に作れるようになっていること。
  つまり、今回のインストーラ作成スクリプトも納品すること。
  またそのスクリプトを我々が自由に改変できること。読みやすく改変しやすいように
  作ってあること。スクリプトに十分なコメントを入れてあること。
  
8) インストーラは以下のコンポーネントで構成される。
  （インストール先が C:\Meadow の場合)
  ・Meadow本体のファイル群
    C:\Meadow\1.15\ 以下にインストールする。
    1.15 はMeadowのバージョン名で今後変わることもある。
  ・Emacs Lispファイル群
    C:\Meadow\site-lisp\emacspeak\ 以下にインストールする。
  ・Windows Speech Server (speak.exe)
    C:\Meadow\1.15\bin\speak.exe に置く。
  ・ドキュメントや初期化ファイルなど上記に入らないもの。
    C:\Meadow\site-lisp\site-start.el (BEPの設定ファイル)
    C:\Meadow\ 以下にいくつかのドキュメントを置く。
  ・その他
   # 今回はMewなどのLispパッケージは管理しない。将来の宿題にする。
 
9) インストーラの諸注意
 (1) ユーザがhome環境変数を設定していたらそれを使う。このインストーラで前に
   BEPをインストールしていたらそのときの場所を使う。そうでなかったら default値
   として C:\Meadow\home を使う。いずれの場合もユーザにこれでよいか確認を求める。
   このhomeディレクトリの場所は、Meadowのインストール時などに使われる。
 
   homeディレクトリが既に存在していた場合、そこにあるファイルを勝手に上書き
   したり消したりしてはいけない。
 
  (2) インストーラには bepwin01.exe のような 2桁のバージョン番号付きの名前を
   付けます。
  注; 単体の圧縮ファイルとして作成する場合は、この bepwin01.exe が17MBほどの
     ファイルになる。

  (3) 配布ファイルのうち、Meadowだけはバージョンによってインストールされる
   場所が異なります。例; C:\Meadow\1.15\

  (4) Meadowはレジストリにいくつかの情報を書き込みます。
   たとえばレジストリにあるMeadowのパス
      HKey_Local_Machine\Software\GNU\Meadow\1.15\Environment
   の下のキー EMACSPATH が、Meadowの実行ファイル(実は Meadownt.exe などを
   呼び出すだけのラウンチャー)Meadow.exe の場所を指しています。
  （たとえば C:\Meadow\1.15\bin ）

   このように、レジストリにはMeadowの入っているディレクトリのパス名が含まれて
   いるので、同じバージョンのMeadowが2箇所にあった場合、レジストリに書かれて
   いる場所以外のMeadowは機能できないはずです。したがってこのようなMeadowを
   削除してもユーザに影響を及ぼしません。
    
  (5) アンインストール時のMeadowの取り扱い
   (5a) 単にBEPをアンインストールする場合、Meadowをインストールしたディレクトリ
     以下を消して、インストールしたMeadowに対応するレジストリも消去します。
     このMeadowのレジストリを消す作業を忘れないでください。

   (5b) 新たにBEPをインストールするときも、既に存在しているBEPを消す必要があり
     ます。そのような場合、以下の点に注意してください。
    ・このインストーラが過去にインストールしたMeadowをアンインストールする場合、
      確認を求めるメッセージを出して、許可が得られればファイルはもちろん、
      レジストリのキーも消してよい。
      バージョンが異なっていてもこの作業を行う。
    ・このインストーラでインストールされたものではないがバージョンが異なる
      Meadowが存在していた場合、ファイルもレジストリもそのまま残しておく。
    ・このインストーラでインストールしたのではないがバージョンが同じMeadowが
      すでに存在していた場合、原則として新しいほうのMeadowのファイルとレジストリ
      を残し、古いほうのMeadowは、ユーザに確認を求めた上で、許可を得たら
      ファイルだけ削除してレジストリは残す。
問題点: 消す必要があるか?  ファイルは放置してもよいのではないか?
      ただし、以下の場合は例外：
        レジストリに書いてある場所とインストーラが記録している場所が異なる場合、
        BEPインストールの後でユーザが独自にMeadowを入れたと思われます。
        この場合は、例外として古いほうではなくユーザが独自に入れた
        Meadowを消去の対象とします。
      これ以外の場合、レジストリを見れば古い方のMeadowの場所がわかります。
   (5c) BEPのELispファイル：Meadowディレクトリ以下にあるELispファイルは、
      Meadowと運命をともにします。
   (5d) アンインストール時もhomeディレクトリの下は残す。
      homeディレクトリがインストーラが作ったディレクトリの下にあっても残す。
      ユーザが作ったファイルはアンストール時に消えないと思うけれども、
      絶対消さないようにすること。
      また、このディレクトリ以下を消さないことを、あらかじめユーザに通知する。

  (6) インストール時はHDの空き容量不足も監視する。
      小さなファイルの数が多く、クラスタサイズに大きく影響されるので注意する。

  (7) speak.exe はMFCのDLLが必要。

  (8) インストールの種類として普通はコンパクト、標準、カスタムを用意するが、
    今回のインストーラは1種類(標準インストール)しか用意しない。

  (9) 前回インストールした場所とhomeディレクトリの場所をインストール時に使うので、
    これらの値を記録しなければならない。

  (10) ダイアログボックスに長いメッセージを表示するとスクリーンリーダが
    全部を読めないので、長いメッセージを表示する場合は、
    テキスト表示コントロール(エディットボックス)で表示するなどの工夫が必要。
    
   (11) そのほか、InstallShieldが使うダイアログボックスなどの中にスクリーン
    リーダで読むとわかりにくいものがあるので、こちらで把握している範囲の
    注意点を別途お渡しします。いずれにしても試作品の段階でユーザテストをする
    必要があります。

10) インストーラの手順：
 基本的には、インストール作成ソフトの通常の手順に従って作成するが、
 以下の点に注意して欲しい。

 (1) 最初にこのインストーラが何をするかとか、インストール時の注意(BEPやEmacsを
   終了してからインストールすることなど）などの注意を表示する。
   この注意の内容(かなり長いファイルになる)はこちらで用意する。

 (2) BEPをインストールする前にまずSAPI 4が入っているかどうか自動的に
    確認する。入っていない場合はメッセージを出す。
    また、SAPI 4をインストールしてよいかどうか問い合わせて、OKならば
    ネットワーク越しにダウンロードしてインストールする。
    spchapi.exe (825KB)の場所：
      http://activex.microsoft.com/activex/controls/sapi/spchapi.exe
    SAPI 3を使っているユーザがいるが、BEPはSAPI 4でしか動かない。
    SAPI 3を使っている場合は「BEPを使うにはSAPI4が必要だがSAPI 4を入れる
    と既存の音声合成環境に不具合が出る可能性がある」というメッセージを
    出してインストールを中止する。
要確認：WinXPにはSAPI 5が入っているのでこれはアンインストールしない方がよい。
    WinXPの場合、SAPI 4と共存できるかどうか確認する必要がある。

 (3) SAPI確認の後、インストール済みの音声合成エンジンの種類を確認する。
    必要なものが入っていない場合はメッセージを出す。
   ・英語エンジンに関してはMSのエンジンをインストールしてよいかどうか
     問い合わせて、OKならばネットワーク越しにダウンロードしてインストールする。
     msttsL.exe (7.3MB)の場所：
     http://download.microsoft.com/msdownload/sapi/4.0/rtw/4.0a/en/msttsL.EXE
   ・日本語エンジン：今回はProTalker 97が必要なので以下のメッセージを出す。
    （ただしダイアログボックスに収まりきらないので、スクリーンリーダが
      読める方法で表示する。)

          日本語音声合成ライブラリの IBM ProTalker 97 は、IBM の商品 
       (9800円) です。Protalker 97 は、音声合成だけの単体の商品として
       パソコンショップで購入できます。
          IBM のホームページリーダーや、PC-Talker/VDM100W あるいは JAWS 
       などは内部的に IBM ProTalker 97 を使用しています。したがって、
       これらのソフトウェアが既にインストールされている場合は、特に何
       もしなくても BEP は動作します。ただし、ライセンスの関係上 BEP 
       用には別途単体版の ProTalker を購入する必要があります。

       [注意] すでに ProTalker が動作している環境で更に単体版の 
       ProTalker をインストールすると、既存の環境がおかしくなる可能性
       があります。不明の点は BEP メーリングリスト (下記) までお問い合
       わせください。

     次バージョンでは東芝やドキュメントトーカを使う予定だが、今回は考慮しなく
     てもよい。
     ただし、インストール済み言語の判定方法が、インストーラスクリプト以外の
     プログラムを使うなら、そのプログラムあるいはそのソースもほしい。

 (4) BEPをインストールする場所(これをMeadowディレクトリと呼び、この下にすべての
   モジュールがインストールされる)を問い合わせる。defaultは C:\Meadow。
   もしユーザがルートディレクトリを指定したら、ルートの下にMeadowという名の
   ディレクトリを作ってその下にインストールした方がよいと表示。
   もしユーザが半角英数字といくつかの記号以外の文字でディレクトリを指定したら、
   BEPが正常に動作しない可能性があると言うメッセージを表示。

 (5) すでにMeadowやBEPが存在していないか調べる。もしあったらその旨メッセージを
   出し、homeディレクトリ以外を完全に消してよいかどうか確認する。
   Yesだったらアンインストールの作業を行う。Noだったら作業を中断する。
   この作業の詳細は 9)-(5)に従います。

 (6) ユーザがhome環境変数を設定していなかったら、Meadowの初期設定ファイル
   などを置くhomeディレクトリをどこにするかをユーザに問い合わせる。
   defaultはMeadowディレクトリの下のhomeディレクトリ。
   もしhome環境変数が設定されていたらそれを使う。
   もしユーザが半角英数字といくつかの記号以外の文字でディレクトリを指定したら、
   BEPが正常に動作しない可能性があると言うメッセージを表示。

 (7) インストールされる場所(C:\Meadow)やホームディレクトリの場所
     (C:\Meadow\home)などの情報を表示して確認を求める。

 (8) インストール開始。

 (9) Meadowのインストーラの引数にhomeディレクトリの場所を渡して、
     Meadowのインストーラを実行。
     例; C:\Meadowの下で、1.15\install.exe -h HOMEDIRECTORYNAME を実行
         HOMEDIRECTORYNAMEはドライブ名からのパス名で、区切りは「\」にする。

 (10) .emacs が存在していない場合、後で便利なようにEmacsの初期化ファイルを作る
     かどうか尋ねる。Yesだったら homeディレクトリに ダミーの .emacs を置く。
     このファイルもこちらで用意する。

 (11) 終了メッセージを表示。このファイル(長いファイル)もこちらで用意する。

 
-------------------------------------------------------------------------
参考までにBEPの動作原理やEmacsの基礎知識を書いておきます。
ご存知のことも多いと思いますが念のため。

1. BEPの動作原理

1.1 Emacs

BEPはEmacsを音声化するシステムです。EmacsはUnixで標準的な高機能エディタですが、
Emacs Lisp (ELisp)プログラミング言語のプラットホームでもあり、Emacs自身も
primitiveな機能はCで書かれていますが、それ以外はELispで実装されています。また
Emacsにはいろいろな亜種があり、Unix以外のOSでもかなりコンパイルできるようになっ
ています。我々がWindowsで使っているのはMeadowという名のEmacsで、MS IMEやホイール
マウスなどに対応しています。

現在のMeadowのバージョンは1.15で、Emacs 20.7に対応します。
Emacs自身は最近Emacs 21がリリースされ、かなりGUI化されました。

またEmacsは GNU GPLというライセンスで公開されており、ソースの再配布や改変の自由
が保障されています。我々のBEPも同じライセンスで公開しています。

1.2 ELispとバイトコンパイル

ELispコードのファイルはel (Emacs Lispの略)という拡張子を持ちます。Lispはインター
プリタ型の言語でありこのままでは実行速度が遅くなるので、あらかじめelファイルをバ
イトコンパイルしておきます。バイトコンパイルしたファイルの拡張子は elc です。el 
ファイルと elc ファイルの両方がある場合は elc を読み込みますが、 el しかない場合
は el を読み込みます。注意しなければいけないのは、バイトコンパイルされたELispコー
ドはEmacsのバイジョンが違うと互換性がない場合があるということです。したがって、
Emacsを変えた場合は、バイトコンパイルしなおした方が安全です。これは普通Makefile
などを使って、素のEmacs、つまり余分なコードをロードしていないEmacs、を使ってコン
パイルしなおします。

1.3 BEPの原理と構成要素

BEPはELisp部分と、スピーチサーバの2つのソフトウェアで構成されます。Elisp部分(BEP
部と呼ぶことが多い)はEmacsの関数にhookして、Emacsの情報を取り出します。このELisp
ファイルだけでもかなりの数のファイルで構成されます。これはもともとRaman博士が書
いたEmacspeakを2ヶ国語に拡張して日本語特有の機能を追加したものです。まだまだ未完
成ですが、使えるようになってきています。このElisp部は大きく分けて2つのバージョン
があります。

・今回使うバージョン(BEP1と呼びましょう。)。スピーチサーバ内で文字コードを
  見ることで言語を自動的に切り替えています。
・2月ごろ出す予定の新しいバージョン(BEP2と呼びましょう。)
  Elisp部で言語を判断し、音声化に使うエンジンの言語を指定できます。
  また英語はネイティブ発音とカタカナ英語の2種類の発音を指定できます。

スピーチサーバは独立したアプリケーションです。BEPにはWindows用とLinux用の2つのス
ピーチサーバを開発しています。スピーチサーバは、標準入力に送り込まれた文字列を解
析して、インテキストコマンドを解釈し、文字列を読み上げます。Windows版はSAPI 4に
対応した音声合成ライブラリを使っており Speak.exe という名前です。これにもいくつ
かバージョンがあり、
・SS1：英語はMSの英語のエンジン、日本語はProTalkerがしゃべり、日米両言語を
       自動切換えでしゃべる。BEP1に対応。今回の簡単インストーラに同梱されている。
・SS2：英語も日本語も東芝がしゃべる。英語はカタカナ英語でしゃべる。
       1月中にこのSSを用いた簡単インストーラを出す予定。
・SS3：BEP2に対応したスピーチサーバで、英語はMSの英語のエンジン、日本語は東芝が
       しゃべる。また英語をカタカナ英語でしゃべらすことも出来る。
       2月までに完成させます。
・SS4: 日本語のエンジンを、東芝とドキュメントトーカから選べるようにする。
       日本語は全部ドキュメントトーカにしたり、日本語は東芝、カタカナ英語は
       ドキュメントトーカとか使い分けることが出来るようにしたい。
       これも2月中に作りたいのですが、私の力量では苦しいので小出さんのところで
       外注しようと思ったわけです。

1.4 EmacsのLispライブラリ (Lispパッケージとかモジュールとかいうこともあります)

Emacsが面白いというか、高機能なのはELispで書かれたパッケージを用いて機能を拡張で
きることです。BEP自身もそういう機能拡張の一種ですが、電子メール Mew、Webブラウザ 
W3やw3m、ファイラー dired、shell、などの各種パッケージがあります。このような
ELispパッケージは site-lisp という名前のディレクトリの下に入れられます。

1.5 ディレクトリ構成

今回の標準ディレクトリ構成は、

(C:\ の直下に)
 Meadow\1.15\            1.15はバージョン名です。
             bin\        ＜＝ ここが Speak.exe の置き場所
             etc\        その他のファイル
             lisp\       Emacs本体のELispファイル
             site-lisp\  Emacsのバージョンに依存するパッケージを置く場所
             info\       info というUnix形式のマニュアルの置き場所
            
        site-lisp\       Emacsのバージョンに依存しないパッケージを置く場所
                  emacspeak\ ＜＝ ここが BEP Elispの置き場所
                  mew\ (これは入っていない)
                  w3m\ (これも入っていない)

という風になっています。
今回のdefaultは C:\Meadow 以下にファイルを置くつもりです。

これ以外に大事なディレクトリが ホームディレクトリです。Unixの場合はログインディ
レクトリがホームディレクトリですがWindowsにはそういう概念がないので、どこをホー
ムディレクトリにするか設定してあげなければいけません。(MeadowやMewなどいくつかの
プログラムがこのディレクトリに設定ファイルを置きます。) 今回の簡易インストーラで
は簡便のために、defaultでは Meadow\home\ というディレクトリを作ります。

注意すべきことは、Emacs関連のアプリケーションは日本語や空白が含まれるディレクト
リ名を扱えない可能性があるということです。ですからユーザが、"Program Files"とか
"Documents and Settings"とか"渡辺"とかいう名前のディレクトリを使おうとした場合は
警告してこれをはねる必要があります。

1.6 Meadowのインストール

Meadowのインストールはとっても簡単で、Meadowの配布ファイルを展開した後、
Meadow\1.15\install.exe を実行するだけです。このインストーラはhomeディレクトリの
設定とdumpという作業を行います。install.exeのコマンド引数でホームディレクトリの
場所を指定できます。ちなみに環境変数homeが設定されていれば、Meadowはそれを検出し
てその場所をMeadowのホームディレクトリにします。そしてその値をレジストリに書き込
みます。

Meadowは特別なDLLを別に必要としません。

1.7 BEPのインストール

我々が作った簡単インストールでは、BEPのELispはバイトコンパイルした状態で配布して
います。EmacsとバイトコンパイルされたBEPの相性の問題を考えなくてよいならばこの状
態で配布して、site-lispの下に展開して、初期設定ファイル 
Meadow\site-lisp\site-start.el を設定してやればそれで終わりです。そうでない場合
をどうするかはまだ考慮中です。BEPも特別なDLLなどを必要としません。

1.8 スピーチサーバのインストール

これは簡単です。Meadow\1.15\bin\Speak.exe におけば終わり。
スピーチサーバはMFCのDLLを必要とします。

以上。